---
import { Image, getImage } from 'astro:assets';
import CakeCarousel from './react/CakeCarousel';
import { cakeCarouselSlides, carouselImageSizes, carouselImageWidths } from './react/carousel-slides';

function pickFallbackSrc(
  candidates: { url: string; descriptor?: string }[],
  preferredWidth: number
): string {
  const parsed = candidates
    .map((candidate) => ({
      ...candidate,
      width: candidate.descriptor?.endsWith('w') ? Number.parseInt(candidate.descriptor, 10) : Number.NaN
    }))
    .filter((candidate) => Number.isFinite(candidate.width))
    .sort((left, right) => left.width - right.width);

  if (parsed.length === 0) {
    return candidates[0]?.url ?? '';
  }

  const atOrBelowPreferred = [...parsed].reverse().find((candidate) => candidate.width <= preferredWidth);
  return atOrBelowPreferred?.url ?? parsed[0].url;
}

const fallbackWidth = 860;

const optimizedSlides = await Promise.all(
  cakeCarouselSlides.map(async (slide) => {
    const webpImage = await getImage({
      src: slide.image,
      widths: [...carouselImageWidths],
      format: 'webp',
      quality: 72
    });

    const jpegImage = await getImage({
      src: slide.image,
      widths: [...carouselImageWidths],
      format: 'jpg',
      quality: 78
    });

    return {
      id: slide.id,
      alt: slide.alt,
      fallbackSrc: pickFallbackSrc(jpegImage.srcSet.values, fallbackWidth) || jpegImage.src,
      fallbackSrcSet: jpegImage.srcSet.attribute,
      webpSrcSet: webpImage.srcSet.attribute,
      sizes: carouselImageSizes,
      width: slide.image.width,
      height: slide.image.height
    };
  })
);
---

<section class="section gallery" id="gallery" aria-label="Recent Dillz Bites cake creations">
  <div class="container">
    <p class="eyebrow" data-reveal>Recent Work</p>
    <h2 class="section-title" data-reveal>A gallery of hand-finished cakes</h2>
    <p class="section-intro" data-reveal>
      Every cake starts with a conversation. Browse recent designs for inspiration and note what styles, colors,
      and mood you want us to build around your event.
    </p>

    <div class="carousel-shell" data-reveal>
      <noscript>
        <figure class="gallery-fallback">
          <Image src={cakeCarouselSlides[0].image} alt={cakeCarouselSlides[0].alt} widths={[760, 980]} />
        </figure>
      </noscript>

      <CakeCarousel client:visible slides={optimizedSlides} autoplayDelay={7000} />
    </div>
  </div>
</section>

<style>
  .gallery {
    background: linear-gradient(180deg, var(--surface-muted), var(--bg-surface));
  }

  .carousel-shell {
    margin-top: var(--space-6);
    background: var(--bg-surface);
    border: 1px solid var(--border-soft);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: clamp(1rem, 2vw, 1.5rem);
  }

  .gallery-fallback {
    margin: 0;
    border-radius: var(--radius-md);
    overflow: clip;
  }
</style>
